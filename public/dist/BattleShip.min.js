/*! BattleShip 23-06-2016 */
"use strict";var appCtrls=angular.module("AppCtrls",[]);appCtrls.controller("AppCtrl",["$scope","socket","game",function(a,b,c){c.initGame(),$("#viewport").attr("content","user-scalable=no, initial-scale=1, width=device-width"),a.availableGames=[{n:"Play online",r:0}],a.user={},a.play=function(c){var d=c,e={};e.nickname=a.user.nickname,e.room=d,$("#mainView").hide();var f=1/window.devicePixelRatio;$("#viewport").attr("content","user-scalable=no, initial-scale="+f+", width=device-width"),b.emit(EventCode.JOIN_GAME,e,!0)},b.on(EventCode.INI_STATUS,function(a){c.setInitialStatus(a.is),b.id=a.id,c.startGame()})}]),appCtrls.controller("MessagesCtrl",["$scope","socket",function(a,b){a.message="",a.sendMessage=function(c){var d=c.trim();d&&(b.emit(EventCode.CHAT_MESSAGE,{id:b.id,m:c},!0),a.message="")}}]),appCtrls.controller("LoginCtrl",["$scope","socket",function(a,b){a.user={nickname:""},a.hideLogin=!1,a.showWelcome=!1,a.sendUserData=function(){a.user.nickname.trim()&&(b.nickname=a.user.nickname,a.hideLogin=!0,a.showWelcome=!0)}}]).config(["$mdThemingProvider",function(a){a.theme("docs-dark","default").primaryPalette("yellow").dark()}]),appCtrls.factory("socket",["$rootScope",function(a){var b,c=new WebSocket("ws://"+window.location.hostname+":8000"),d=[];c.binaryType="arraybuffer",c.onclose=function(){console.log("disconnected"),window.location.href="/"};var e=function(a){var b=new Uint8Array(a),c=b[0];return{type:c,data:b}},f=function(a){var b=JSON.parse(a);return{type:b.t,data:b.d}};return c.emit=function(a,b,d){d?c.send(JSON.stringify({t:a,d:b})):c.send(b)},c.onopen=function(){console.log("connection opened")},c.onmessage=function(a){var b;b="string"==typeof a.data?f(a.data):e(a.data);var c=b.type,g=b.data;d.forEach(function(a,b){if(c===b){var e=g;d[b](e)}})},{on:function(a,b){d[a]=b},emit:function(a,b,d){c.emit(a,b,d)},id:b,nickname:""}}]),appCtrls.factory("game",["$rootScope","socket",function(a,b){var c,d,e,f,g;return d=function(a){c.setInitialStatus(a)},e=function(){var a={};return a.w=$(window).width()*window.devicePixelRatio,a.h=$(window).height()*window.devicePixelRatio,a},f=function(){c=new BattleShip(e().w,e().h,"",b),c.init()},g=function(){$("#mainView").hide(),c.start()},{initGame:f,startGame:g,setInitialStatus:d}}]),angular.module("BattleShip",["ngMaterial","AppCtrls","ngRoute"]).config(["$mdIconProvider","$mdThemingProvider","$routeProvider",function(a,b,c){var d="assets/icons/";b.theme("altTheme").primaryPalette("blue").accentPalette("red"),a.icon("settings",d+"settings.svg",24).icon("game",d+"game-icon.svg",32).icon("menu",d+"menu.svg",24).icon("team",d+"team.svg",24),c.when("/",{templateUrl:"static/partials/landing.html",controller:"AppCtrl"}).when("/game",{templateUrl:"static/partials/game.html",controller:"GameCtrl"}).otherwise({redirectTo:"/"})}]);var BattleShip=function(a,b,c,d){Phaser.Game.call(this,a,b,Phaser.CANVAS,c),this.socket=d,this.players=[],this.coins=[],this.enemies=[],this.waiting=!1,this.started=!1,this.PingActive=!1,this.state.add("boot",BootState),this.state.add("load",LoadState),this.state.add("play",PlayState),this.initSocketHandlers(),this.o};BattleShip.prototype=Object.create(Phaser.Game.prototype),BattleShip.prototype.constructor=BattleShip,BattleShip.prototype.init=function(){this.state.start("boot",!1,!1,null)},BattleShip.prototype.start=function(){this.state.start("play",!1,!1,null)},BattleShip.prototype.setInitialStatus=function(a){this.initialStatus=a},BattleShip.prototype.startPing=function(){var a=this.time.create(!1);this.socket.emit(EventCode.PING,Date.now(),!0),a.loop(1e3,function(){this.PingActive=!0,this.socket.emit(EventCode.PING,Date.now(),!0)}.bind(this),this),a.start()},BattleShip.prototype.initSocketHandlers=function(){this.socket.on(EventCode.UPDATE_GAME,this.onUpdateGame.bind(this)),this.socket.on(EventCode.PING,this.onPing.bind(this)),this.socket.on(EventCode.NEW_PLAYER,this.onPlayerJoined.bind(this)),this.socket.on(EventCode.PLAYER_LEFT,this.onPlayerLeft.bind(this)),this.socket.on(EventCode.CHAT_MESSAGE,this.onChatMessage.bind(this)),this.socket.on(EventCode.COINS,this.onCoins.bind(this)),this.socket.on(EventCode.LEADERBOARD,this.onLeaderboard.bind(this))},BattleShip.prototype.onPing=function(a){this.net_latency=Date.now()-a},BattleShip.prototype.onLeaderboard=function(a){for(var b="Leaderboard \n\n",c=0;c<a.length;c++){var d=null===a[c]?"anonymous":a[c];b=b.concat(c+1+". "+d+"\n")}this.leaderboard&&this.leaderboard.setText(b)},BattleShip.prototype.onCoins=function(a){for(var b=a,c=0,d=1;d<b.length;d+=4){var e=new Uint16Array(new Uint8Array([b[d],b[d+1]]).buffer)[0],f=new Uint16Array(new Uint8Array([b[d+2],b[d+3]]).buffer)[0];this.coins[c]=[e,f],c++}},BattleShip.prototype.onChatMessage=function(a){for(var b=a.id,c=a.m,d=0;d<this.players.length;d++)if(this.players[d].id===b){this.players[d].showMessage(c),this.showMessageToAll(this.players[d].nickname,c);break}},BattleShip.prototype.showMessageToAll=function(a,b){this.messagesToAll.setText(a+" says "+b)},BattleShip.prototype.onPlayerJoined=function(a){var b=new Player(this,a.player);this.players.push(b),this.layerPlayers.add(b),this.players.length>=2&&(this.waiting=!1)},BattleShip.prototype.onUpdateGame=function(a){if(this.started){var b=this.getBinaryEntities(1,a);this.getBinaryEntities(b,a)}},BattleShip.prototype.getBinaryEntities=function(a,b){var c,d=b[a],e=b[a+1];switch(d){case Entity.Player.TYPE:c=Entity.Player.LEN;var f=a+2;break;case Entity.Enemy.TYPE:var g=b[a+2],f=a+3;g===Entity.Enemy.TypeOfMessage.Update.CODE?c=Entity.Enemy.TypeOfMessage.Update.LEN:g===Entity.Enemy.TypeOfMessage.Kill.CODE?c=Entity.Enemy.TypeOfMessage.Kill.LEN:g===Entity.Enemy.TypeOfMessage.Create.CODE&&(c=Entity.Enemy.TypeOfMessage.Create.LEN)}for(var h=0;e>h;h++){h>0&&d===Entity.Enemy.TYPE&&(g=b[f],c=this.getLenOfBinaryMessage(d,g),f++),console.log(b);var i=b,j=i.slice(f,f+c),k=j[0];if(d===Entity.Player.TYPE){var l=this.getPlayerById(k);l&&l.updateBuffer(j)}if(d===Entity.Enemy.TYPE)switch(g){case Entity.Enemy.TypeOfMessage.Update.CODE:var m=this.getEnemyById(k);m&&m.updateBuffer(j);break;case Entity.Enemy.TypeOfMessage.Kill.CODE:var m=this.getEnemyById(k);m&&m.tweenToDie();var n=this.enemies.indexOf(m);this.enemies.splice(n,1);break;case Entity.Enemy.TypeOfMessage.Create.CODE:if(this.layerEnemies){for(var o=!1,p=0;p<this.enemies.length;p++)if(this.enemies[p].id===k){o=!0;break}if(o)continue;var m=new Enemy(this,0,0,"enemy",0,k);this.layerEnemies.add(m),this.enemies.push(m)}}f+=c}return f},BattleShip.prototype.getLenOfBinaryMessage=function(a,b){var c;switch(a){case Entity.Player.TYPE:c=Entity.Player.LEN;break;case Entity.Enemy.TYPE:b===Entity.Enemy.TypeOfMessage.Update.CODE?c=Entity.Enemy.TypeOfMessage.Update.LEN:b===Entity.Enemy.TypeOfMessage.Kill.CODE?c=Entity.Enemy.TypeOfMessage.Kill.LEN:b===Entity.Enemy.TypeOfMessage.Create.CODE&&(c=Entity.Enemy.TypeOfMessage.Create.LEN)}return c},BattleShip.prototype.getPlayerById=function(a){for(var b=0;b<this.players.length;b++)if(this.players[b].id===a)return this.players[b]},BattleShip.prototype.getEnemyById=function(a){for(var b=0;b<this.enemies.length;b++)if(this.enemies[b].id===a)return this.enemies[b]},BattleShip.prototype.onPlayerLeft=function(a){for(var b=a.id,c=a.t,d=0;d<this.players.length;d++)if(b===this.players[d].id)switch(this.started=!1,c){case"w":this.whirlwindCollision(this.players[d]);break;case"b":this.otherPlayerCollision(this.players[d])}},BattleShip.prototype.whirlwindCollision=function(a){if(!a.isBouncing){a.isBouncing=!0,a.tint=11744050.5,a.gun.destroy();var b=this.add.tween(a);b.to({width:0,height:0,angle:720},500),b.onComplete.add(function(){this.killPlayer(a)}.bind(this),this),b.start()}},BattleShip.prototype.otherPlayerCollision=function(a){if(!a.isBouncing){a.isBouncing=!0,a.tint=11744050.5,a.gun.destroy();var b=this.add.tween(a);b.to({alpha:0},500),b.onComplete.add(function(){this.killPlayer(a)}.bind(this),this),b.start()}},BattleShip.prototype.killPlayer=function(a){if(a.id===this.socket.id)$("#mainView").show(),this.device.desktop&&a.emitter.destroy(),a.destroy();else{this.device.desktop&&a.emitter.destroy(),a.gun.destroy(),a.destroy();var b=this.players.indexOf(a);this.players.splice(b,1),1===this.players.length&&this.players[0].id===this.socket.id?this.waitingLabel?this.waitingLabel.revive():(this.waitingLabel=this.add.bitmapText(255,255,"p2",this.socket.nickname.toUpperCase()+" \nwaiting for other players...",20),this.waitingLabel.fixedToCamera=!0,this.waitingLabel.angle=180,this.waiting=!0):void 0!==this.waitingLabel&&this.waitingLabel.destroy()}},BattleShip.prototype.getInterpolatedData=function(a,b,c,d){var e,f,g,h=new Array(d);if(a[a.length-1]===a[0]&&b[b.length-1]===b[0]&&c[c.length-1]===c[0]){for(var i=0;d>i;i++)h[i]=[a[0],b[0],c[0]];return h}e=a[a.length-1]!==a[0]?1/(d-1):0,f=b[b.length-1]!==b[0]?1/(d-1):0,c[c.length-1]!==c[0]?(c[c.length-1]<0&&(c[c.length-1]=c[c.length-1]+2*Math.PI),c[0]<0&&(c[0]=c[0]+2*Math.PI),Math.abs(c[c.length-1]-c[0])>2*Math.PI-Math.abs(c[c.length-1]-c[0])&&(c[c.length-1]=c[c.length-1]-2*Math.PI),g=1/(d-1)):g=0;for(var i=0;d>i;i++){var j=this.math.linearInterpolation(a,parseFloat(e*i)),k=this.math.linearInterpolation(b,parseFloat(f*i)),l=this.math.linearInterpolation(c,parseFloat(g*i));l>Math.PI&&(l-=2*Math.PI),h[i]=[j,k,l]}return h};var Missile=function(a,b,c,d,e,f){Phaser.Sprite.call(this,a,b,c,d,e),this.WOBBLE_LIMIT=15,this.WOBBLE_SPEED=100,this.anchor=new Phaser.Point(.5,.5),this.game.physics.enable(this,Phaser.Physics.ARCADE),this.exists=!1,this.wobble=this.WOBBLE_LIMIT,this.explode=!0,this.player=f,this.game.add.tween(this).to({wobble:-this.WOBBLE_LIMIT},this.WOBBLE_SPEED,Phaser.Easing.Sinusoidal.Out,!0,0,Number.POSITIVE_INFINITY,!0),this.explosion=a.add.sprite(0,0,"bexplosion"),this.explosion.visible=!1,this.explosion.animations.add("explosion"),this.explosion.anchor.setTo(.5),this.events.onKilled.add(this.dieWithExplosion,this)};Missile.prototype=Object.create(Phaser.Sprite.prototype),Missile.prototype.constructor=Missile,Missile.prototype.update=function(){switch(this.rotation=this.targetRotation+this.game.math.degToRad(this.wobble),this.player.level){case 1:break;case 2:this.explosion.scale.setTo(1.2);break;case 3:this.explosion.scale.setTo(1.9)}},Missile.prototype.dieWithExplosion=function(){this.explode&&(this.explosion.reset(this.x,this.y),this.explosion.play("explosion",10,!1,!0))};var Enemy=function(a,b,c,d,e,f){Phaser.Sprite.call(this,a,b,c,d,e),this.anchor=new Phaser.Point(.5,.5),this.game.physics.enable(this,Phaser.Physics.ARCADE),this.coorBuffer=[],this.anchor.setTo(.5),this.id=f,this.visible=!1,this.moves=!1,this.explosion=a.add.sprite(0,0,"explosion"),this.explosion.visible=!1,this.explosion.animations.add("explosion"),this.explosion.anchor.setTo(.5),this.time_acumulator=0,this.num_frames=5,console.log("enemy id:"+this.id)};Enemy.prototype=Object.create(Phaser.Sprite.prototype),Enemy.prototype.constructor=Enemy,Enemy.prototype.I_X=1,Enemy.prototype.I_Y=2,Enemy.prototype.I_R=3,Enemy.prototype.I_S=4,Enemy.prototype.INI_FRAMES=2,Enemy.prototype.minFrames=2,Enemy.prototype.tweenComplete=!0,Enemy.prototype.interpIndex=0,Enemy.prototype.minLen=2,Enemy.prototype.dieWithExplosion=function(){this.explosion.reset(this.x,this.y),this.explosion.play("explosion",10,!1,!0)},Enemy.prototype.tweenToDie=function(){this.dieWithExplosion(),this.destroy()},Enemy.prototype.update=function(){this.updatePhysics()},Enemy.prototype.updatePhysics=function(){return this.tweenComplete&&0===this.coorBuffer.length?void(this.minFrames=this.INI_FRAMES):(this.coorBuffer.length>=this.minFrames&&this.tweenComplete&&(this.minFrames===this.INI_FRAMES&&(this.minFrames=1,this.tweenComplete=!0,this.x=parseFloat(this.coorBuffer[0][this.I_X].toFixed(3)),this.y=parseFloat(this.coorBuffer[0][this.I_Y].toFixed(3)),this.rotation=this.coorBuffer[0][this.I_R],this.coorBuffer.shift()),this.coorBuffer.length>1&&this.coorBuffer.splice(1,this.coorBuffer.length-1),this.latestState=this.coorBuffer[0],this.num_frames>2&&(this.tweenComplete=!1,this.tweenData=this.game.getInterpolatedData([this.x,parseFloat(this.latestState[this.I_X].toFixed(3))],[this.y,parseFloat(this.latestState[this.I_Y].toFixed(3))],[this.rotation,parseFloat(this.latestState[this.I_R].toFixed(3))],this.num_frames),this.tweenData.shift(),this.coorBuffer.shift())),void(this.tweenComplete||this.interpolate()))},Enemy.prototype.updateBuffer=function(a){this.visible=!0;var b=[];b[this.I_X]=new Float32Array(a.slice(1,5).buffer)[0],b[this.I_Y]=new Float32Array(a.slice(5,9).buffer)[0],b[this.I_R]=new Float32Array(a.slice(9,13).buffer)[0],b[this.I_S]=new Uint32Array(a.slice(13,17).buffer)[0],this.coorBuffer.push(b)},Enemy.prototype.interpolate=function(){this.x=parseFloat(this.tweenData[this.interpIndex][0].toFixed(3)),this.y=parseFloat(this.tweenData[this.interpIndex][1].toFixed(3)),this.rotation=parseFloat(this.tweenData[this.interpIndex][2].toFixed(3)),this.interpIndex++,this.interpIndex===this.tweenData.length&&(this.interpIndex=0,this.tweenComplete=!0,this.last=Date.now())};var Player=function(a,b){Phaser.Sprite.call(this,a,parseFloat(b.x.toFixed(3)),parseFloat(b.y.toFixed(3)),"player"),this.status=b,this.coorBuffer=[],this.id=b.id,this.nickname=b.n,this.clientInputs=[],this.clientPredictionInputs=[],this.clientBinaryInputs=new Uint8Array,this.l_x=0,this.l_y=0,this.bulletsArray=[],this.last_update_time=Date.now(),this.id===this.game.socket.id?this.isLocalPlayer=!0:this.isLocalPlayer=!1,this.init()};Player.prototype=Object.create(Phaser.Sprite.prototype),Player.prototype.constructor=Player,Player.prototype.BULLET_INTER_TWO=500,Player.prototype.BULLET_INTER_THREE=400,Player.prototype.VEL_LEVEL_TWO=200,Player.prototype.VEL_LEVEL_THREE=170,Player.prototype.INI_LIFE=30,Player.prototype.MAX_LIFE_ONE=30,Player.prototype.BULLET_FRAME_TWO=0,Player.prototype.BULLET_FRAME_THREE=1,Player.prototype.I_ID=0,Player.prototype.I_B=1,Player.prototype.I_F=2,Player.prototype.I_L=3,Player.prototype.I_K=4,Player.prototype.I_X=5,Player.prototype.I_Y=6,Player.prototype.I_R=7,Player.prototype.I_S=8,Player.prototype.BULLET_LIFESPAN=700,Player.prototype.INI_FRAMES=2,Player.prototype.numInputsToSend=2,Player.prototype.bulletTime=0,Player.prototype.fired=0,Player.prototype.life=Player.prototype.INI_LIFE,Player.prototype.tweenComplete=!0,Player.prototype.minFrames=Player.prototype.INI_FRAMES,Player.prototype.interpIndex=0,Player.prototype.numKills=0,Player.prototype.currentVelocity=300,Player.prototype.curretBulletInterval=400,Player.prototype.emitterVelocityFactor=25,Player.prototype.actualBulletFrame=0,Player.prototype.actualSeqNum=0,Player.prototype.sequence=0,Player.prototype.last_seq=0,Player.prototype.numBullets=30,Player.prototype.minLen=2,Player.prototype.init=function(){this.bullets=this.game.add.physicsGroup(),this.bullets.enableBody=!0,this.bullets.physicsBodyType=Phaser.Physics.ARCADE;for(var a=0;3>a;a++){var b=new Missile(this.game,50,50,"bullets",0,this);this.bullets.add(b),this.bulletsArray.push(b)}this.bullets.setAll("outOfBoundsKill",!0),this.bullets.setAll("checkWorldBounds",!0),this.game.physics.enable(this,Phaser.Physics.ARCADE),this.body.collideWorldBounds=!0,this.body.velocity.x=0,this.body.velocity.y=0,this.anchor=new Phaser.Point(.5,.5),this.scale.setTo(1.3),this.body.moves=!1,this.isLocalPlayer?(this.lifeText=this.game.add.bitmapText(25,3,"p2","Life",15),this.lifeText.fixedToCamera=!0,this.lifeText.angle=-180,this.healthBar=this.game.add.graphics(10,15),this.healthBar.fixedToCamera=!0):(this.healthBar=this.game.add.graphics(-this.body.halfWidth,5*-this.INI_LIFE/12),this.healthBar.rotation=1.5708,this.addChild(this.healthBar)),this.text=this.game.add.bitmapText(-this.body.halfWidth-12,0,"p2",this.nickname,15),this.text.anchor.set(.5),this.text.y=-this.text.width/2,this.text.rotation=-1.5708,this.addChild(this.text),this.message=this.game.add.bitmapText(0,0,"p2","",15),this.message.rotation=Math.PI,this.game.device.desktop&&(this.emitter=this.game.add.emitter(0,0,10),this.emitter.makeParticles(["particle"]),this.emitter.setAlpha(1,.5,500),this.emitter.setScale(3,.3,.8,.3,1e3),this.emitter.start(!1,500,50),this.game.emitterLayer.add(this.emitter)),this.gun=this.game.add.image(0,0,"gun"),this.gun.alpha=0,this.gun.anchor.setTo(.5),this.gun.scale.setTo(1),this.level=1},Player.prototype.showMessage=function(a){this.nickname||(this.nickname="anonym"+this.id),this.message.setText(this.nickname+": "+a),this.clearMessage&&clearInterval(this.clearMessage),this.clearMessage=setTimeout(function(){this.message.setText("")}.bind(this),2e3)},Player.prototype.updateBuffer=function(a){this.coorBuffer.length>5&&(this.minFrames=this.INI_FRAMES,this.coorBuffer=[]);var b=[];b[this.I_B]=a[this.I_B],b[this.I_S]=new Uint32Array(a.slice(17,21).buffer)[0],b[this.I_K]=a[this.I_K],b[this.I_F]=a[this.I_F],b[this.I_L]=a[this.I_L],b[this.I_X]=new Float32Array(a.slice(5,9).buffer)[0],b[this.I_Y]=new Float32Array(a.slice(9,13).buffer)[0],b[this.I_R]=new Float32Array(a.slice(13,17).buffer)[0],void 0!==b[this.I_S]&&-1!==b[this.I_S]&&b[this.I_S]!==this.last_seq&&this.coorBuffer.push(b);var c=this.sequence-Math.round(this.game.net_latency/32+b[this.I_S]);this.isLocalPlayer&&c>6?this.stopClientProcessing=!0:this.stopClientProcessing=!1},Player.prototype.update=function(){this.gun.alpha=1,this.updatePhysics(),this.game.device.desktop&&this.updateEmitter(),this.message.x=this.x-this.body.halfWidth-20,this.message.y=this.y-this.body.halfWidth-20,this.checkPlayerLevel(),this.isLocalPlayer?this.drawLocal():this.drawRemote(),this.l_x=this.x,this.l_y=this.y},Player.prototype.checkPlayerLevel=function(){this.numKills>0&&(this.currentVelocity=this.VEL_LEVEL_TWO,this.curretBulletInterval=this.BULLET_INTER_TWO,this.actualBulletFrame=this.BULLET_FRAME_TWO,this.loadTexture("ship-level-2"),this.emitterVelocityFactor=100,this.body.setSize(this.width,this.height,0,0),this.gun.scale.setTo(1.2),this.text.x=-this.body.halfWidth+50,this.text.y=-this.text.width/2,this.level=1),this.numKills>1&&(this.currentVelocity=this.VEL_LEVEL_THREE,this.curretBulletInterval=this.BULLET_INTER_THREE,this.actualBulletFrame=this.BULLET_FRAME_THREE,this.loadTexture("ship-level-3"),this.emitterVelocityFactor=200,this.body.setSize(this.width,this.height,0,0),this.text.x=-this.body.halfWidth+110,this.text.y=-this.text.width/2,this.gun.scale.setTo(1.5),this.level=2)},Player.prototype.updateEmitter=function(){this.vx=this.x-this.l_x,this.vy=this.y-this.l_y;var a=this.vx,b=this.vy;a*=-1,b*=-1,this.emitter.minParticleSpeed.set(a*this.emitterVelocityFactor,b*this.emitterVelocityFactor),this.emitter.maxParticleSpeed.set(a*this.emitterVelocityFactor,b*this.emitterVelocityFactor),this.emitter.emitX=this.x,this.emitter.emitY=this.y},Player.prototype.drawLocal=function(){this.healthBar.clear(),this.healthBar.beginFill(77,1),this.healthBar.drawRoundedRect(10,5,5*this.INI_LIFE,20,5),20<=this.life&&this.life<=30&&this.healthBar.beginFill(3394611,1),10<=this.life&&this.life<20&&this.healthBar.beginFill(16777011,1),0<=this.life&&this.life<10&&this.healthBar.beginFill(15073280,1),this.healthBar.drawRoundedRect(10,7,5*this.life,16,2),this.healthBar.endFill()},Player.prototype.arrayBufferConcat=function(){var a=0,b=null;for(var c in arguments)b=arguments[c],a+=b.byteLength;var d=new Uint8Array(a),e=0;for(var c in arguments)b=arguments[c],d.set(new Uint8Array(b),e),e+=b.byteLength;return d},Player.prototype.sendInputs=function(){var a=new Uint8Array([this.fired]),b=new Uint8Array(new Uint16Array([this.game.input.activePointer.worldX,this.game.input.activePointer.worldY]).buffer),c=this.arrayBufferConcat(a,b);if(this.clientBinaryInputs=this.arrayBufferConcat(this.clientBinaryInputs,c),this.clientBinaryInputs.length===5*this.numInputsToSend){var d=new Uint8Array([EventCode.UPDATE_PLAYER,this.id]);this.clientBinaryInputs=this.arrayBufferConcat(d,this.clientBinaryInputs),this.game.socket.emit("",this.clientBinaryInputs,!1),this.clientBinaryInputs=new Uint8Array}},Player.prototype.drawRemote=function(){this.healthBar.clear(),this.healthBar.beginFill(0,1),this.healthBar.drawRoundedRect(0,0,5*this.INI_LIFE/6,4,2),20<=this.life&&this.life<=30&&this.healthBar.beginFill(3394611,1),10<=this.life&&this.life<20&&this.healthBar.beginFill(16777011,1),0<=this.life&&this.life<10&&this.healthBar.beginFill(15073280,1),this.healthBar.drawRoundedRect(0,0,5*this.life/6,4,2),this.healthBar.endFill()},Player.prototype.interpolate=function(){this.num_seq++,this.x=parseFloat(this.tweenData[this.interpIndex][0].toFixed(3)),this.y=parseFloat(this.tweenData[this.interpIndex][1].toFixed(3)),this.rotation=parseFloat(this.tweenData[this.interpIndex][2].toFixed(3)),this.interpIndex++,this.interpIndex===this.tweenData.length&&(this.interpIndex=0,this.tweenComplete=!0,this.last=Date.now())},Player.prototype.fireBullet=function(){if(Date.now()>this.bulletTime&&this.numBullets>0){var a=this.bullets.getFirstExists(!1);if(a){a.rotation=this.rotation,a.reset(this.x,this.y),a.targetRotation=this.rotation,this.game.physics.arcade.velocityFromRotation(this.rotation,700,a.body.velocity),this.gun.rotation=this.rotation,a.lifespan=1200,a.alpha=0,this.game.time.events.add(100,function(){a.alpha=1}.bind(this)),a.explode=!0,a.frame=this.actualBulletFrame;var b=this.game.add.tween(this.gun),c=this.gun.width,d=this.gun.height;b.to({width:1.2*c,height:1.3*d},100),b.onComplete.add(function(){this.gun.width=c,this.gun.height=d}.bind(this),this),b.start(),this.bulletTime=Date.now()+this.curretBulletInterval}}},Player.prototype.getBullets=function(){return this.bullets},Player.prototype.storeClientInput=function(a){this.clientInputs.push(a)},Player.prototype.remotePlayerPhysics=function(){if(this.tweenComplete&&0===this.coorBuffer.length&&(this.minFrames=this.INI_FRAMES),this.gun.x=this.x,this.gun.y=this.y,this.gun.rotation=this.rotation,this.coorBuffer.length>=this.minFrames&&this.tweenComplete){if(this.coorBuffer.length>this.minLen?this.useInterpolation=!1:this.useInterpolation=!0,this.minFrames===this.INI_FRAMES)return this.x=this.coorBuffer[0][this.I_X],this.y=this.coorBuffer[0][this.I_Y],this.rotation=this.coorBuffer[0][this.I_R],this.last_seq=this.coorBuffer[0][this.I_S],this.numKills=this.coorBuffer[0][this.I_K],this.numBullets=this.coorBuffer[0][this.I_B],this.coorBuffer.shift(),void(this.minFrames=1);this.latestState=this.coorBuffer[0],this.coorBuffer.shift(),this.current_seq=this.latestState[this.I_S],this.numKills=this.latestState[this.I_K],this.fps_inter_fact=this.current_seq-this.last_seq+1,this.last_seq=this.latestState[this.I_S],this.fps_inter_fact>2&&this.useInterpolation?(this.tweenData=this.game.getInterpolatedData([this.x,parseFloat(this.latestState[this.I_X].toFixed(3))],[this.y,parseFloat(this.latestState[this.I_Y].toFixed(3))],[this.rotation,parseFloat(this.latestState[this.I_R].toFixed(3))],this.fps_inter_fact),this.tweenData.shift(),this.tweenComplete=!1,this.latestState[this.I_F]&&this.fireBullet(),this.life=this.latestState[this.I_L],this.numBullets=this.latestState[this.I_B]):2!==this.fps_inter_fact&&this.useInterpolation||(this.tweenComplete=!0,this.x=parseFloat(this.latestState[this.I_X].toFixed(3)),this.y=parseFloat(this.latestState[this.I_Y].toFixed(3)),this.rotation=parseFloat(this.latestState[this.I_R].toFixed(3)),this.latestState[this.I_F]?this.fireBullet():null,this.life=this.latestState[this.I_L],this.numBullets=this.latestState[this.I_B],this.numKills=this.latestState[this.I_K])}this.tweenComplete||this.interpolate()},Player.prototype.localPlayerPhysics=function(){-1===this.game.input.activePointer.worldY||-1===this.game.input.activePointer.worldX||this.stopClientProcessing||(this.minFrames=1,this.clientPredicction(),this.coorBuffer.length>=this.minFrames&&(this.clientCorrection(),this.serverReconciliation()),this.storeClientInput([this.sequence,this.game.input.activePointer.worldX,this.game.input.activePointer.worldY,this.fired]),this.sendInputs(),this.sequence++)},Player.prototype.clientPredicction=function(){if(this.game.physics.arcade.distanceToPointer(this)<100)this.body.velocity.x=0,this.body.velocity.y=0,this.rotation=parseFloat(this.game.physics.arcade.angleToPointer(this).toFixed(3));else{var a=Math.atan2(this.game.input.activePointer.worldY-this.y,this.game.input.activePointer.worldX-this.x),b=this.currentVelocity;this.tempvx=Math.cos(a.toFixed(3))*b,this.tempvy=Math.sin(a.toFixed(3))*b;var c=.016;this.rotation=parseFloat(a.toFixed(3)),this.x+=parseFloat((this.tempvx*c).toFixed(3)),this.y+=parseFloat((this.tempvy*c).toFixed(3))}this.gun.x=parseFloat(this.x.toFixed(3)),this.gun.y=parseFloat(this.y.toFixed(3)),this.gun.rotation=this.rotation,this.fired&&this.fireBullet()},Player.prototype.clientCorrection=function(){this.life=this.coorBuffer[0][this.I_L],this.numKills=this.coorBuffer[0][this.I_K],this.numBullets=this.coorBuffer[0][this.I_B],this.game.numBullets.setText("x"+this.numBullets),this.game.numKills.setText("x"+this.numKills),this.x=parseFloat(this.coorBuffer[0][this.I_X].toFixed(3)),this.y=parseFloat(this.coorBuffer[0][this.I_Y].toFixed(3)),this.actualSeqNum=this.coorBuffer[0][this.I_S],this.last_seq=this.actualSeqNum,this.coorBuffer.shift()},Player.prototype.serverReconciliation=function(){for(var a=0;a<this.clientInputs.length;a++)if(this.clientInputs[a][0]<=this.actualSeqNum)this.clientInputs.splice(a,1),a--;else if(this.game.physics.arcade.distanceToXY(this,this.clientInputs[a][1],this.clientInputs[a][2])>=100){var b=Math.atan2(this.clientInputs[a][2]-this.y,this.clientInputs[a][1]-this.x),c=this.currentVelocity;this.tempvx=Math.cos(b.toFixed(3))*c,this.tempvy=Math.sin(b.toFixed(3))*c;var d=.016;this.x+=parseFloat((this.tempvx*d).toFixed(3)),this.y+=parseFloat((this.tempvy*d).toFixed(3))}},Player.prototype.updatePhysics=function(){this.isLocalPlayer?this.localPlayerPhysics():this.remotePlayerPhysics()};var BootState=function(){};BootState.prototype.preload=function(){this.game.load.image("background","assets/sprites/background.png")},BootState.prototype.create=function(){this.game.world.setBounds(0,0,3810,3540),this.game.scale.scaleMode=Phaser.ScaleManager.RESIZE,this.game.scale.fullScreenScaleMode=Phaser.ScaleManager.SHOW_ALL,this.game.input.maxPointers=1,this.game.device.desktop?this.game.input.touch.enabled=!1:this.game.input.mouse.enabled=!1,this.game.renderer.clearBeforeRender=!1,this.game.input.holdRate=170,this.game.scale.fullScreenTarget=document.getElementById("mBody"),this.game.state.start("load")};var LoadState=function(){};LoadState.prototype.preload=function(){this.background=this.game.add.image(0,0,"background"),this.game.load.onLoadComplete.add(this.onLoadComplete,this),this.game.load.image("skull","assets/sprites/skull.png"),this.game.load.image("particle","assets/sprites/circle.png"),this.game.load.image("player","assets/sprites/ship-level-1.png"),this.game.load.image("ship-level-2","assets/sprites/ship-level-2.png"),this.game.load.image("enemy","assets/sprites/enemymin.png"),this.game.load.image("ship-level-3","assets/sprites/ship-level-3.png"),this.game.load.image("gun","assets/sprites/gunmin.png"),this.game.load.bitmapFont("p2","assets/fonts/open-sans/ops.png","assets/fonts/open-sans/ops.xml"),this.game.load.spritesheet("bullets","assets/sprites/new-bullets-sheet-24.png",34,24,2),this.game.load.spritesheet("coins","assets/sprites/coins.png",40,44,4),this.game.load.spritesheet("whirlwind","assets/sprites/smoke-sheet.png",256,256,15),this.game.load.spritesheet("explosion","assets/sprites/explosion-3.png",128,128,16),this.game.load.spritesheet("bexplosion","assets/sprites/bulletexplosion.png",128,128,16),this.game.device.desktop||(this.game.scale.forceOrientation(!0,!1),this.game.scale.enterIncorrectOrientation.add(this.enterIncorrectOrientation,this),this.game.scale.leaveIncorrectOrientation.add(this.leaveIncorrectOrientation,this),this.game.scale.fullScreenTarget=document.getElementById("mBody"))},LoadState.prototype.onLoadComplete=function(){$("body").show(),this.game.device.desktop&&$("#mainView").show(),this.game.scale.onFullScreenChange.add(function(){this.game.scale.isFullScreen&&this.game.scale.setGameSize(screen.width*window.devicePixelRatio,screen.height*window.devicePixelRatio)}.bind(this),this),!this.game.device.desktop&&this.game.scale.isLandscape&&($(document).one("click",function(){this.game.scale.isFullScreen||this.game.scale.startFullScreen(!0,!0),$("#mainView").show(),$("#touchtostart").hide()}.bind(this)),$("#touchtostart").show())},LoadState.prototype.enterIncorrectOrientation=function(){this.game.orientated=!1,$("#mainView").hide(),this.game.started||$("#incorrectOrientation").show(),$("#touchtostart").hide()},LoadState.prototype.leaveIncorrectOrientation=function(){this.game.orientated=!0,this.game.started||this.game.scale.isFullScreen||$("#touchtostart").show(),$("#incorrectOrientation").hide(),this.game.started||$(document).one("click",function(){this.game.orientated&&!this.game.scale.isFullScreen&&this.game.scale.startFullScreen(!0,!0),$("#mainView").show(),$("#touchtostart").hide()}.bind(this))};var PlayState=function(){this.dialogMessagesActive=!1,this.time_acumulator=0,this.last_time=0};PlayState.prototype.whirlwindCoor=[{x:960,y:960},{x:960,y:2880},{x:2880,y:960},{x:2880,y:2880}],PlayState.prototype.create=function(){this.PingActive||this.game.startPing(),this.game.world.removeAll(),this.game.coins=[],this.game.players=[],this.game.enemies=[],this.background=this.game.add.image(0,0,"background"),this.background2=this.game.add.image(1905,0,"background"),this.background3=this.game.add.image(0,1770,"background"),this.background4=this.game.add.image(1905,1770,"background"),this.layerWhirlwinds=this.game.add.group();for(var a=0;a<this.whirlwindCoor.length;a++){var b=this.whirlwindCoor[a].x,c=this.whirlwindCoor[a].y,d=this.layerWhirlwinds.create(parseFloat(b),parseFloat(c),"whirlwind",0);d.anchor.setTo(.5),d.animations.add("whirlwind"),d.play("whirlwind",10,!0)}this.game.emitterLayer=this.game.add.group(),this.initGame(this.game.initialStatus),this.game.waiting&&(this.game.waitingLabel=this.game.add.bitmapText(255,255,"p2",this.game.socket.nickname.toUpperCase()+" \nwaiting for other players...",20),this.game.waitingLabel.fixedToCamera=!0,this.game.waitingLabel.angle=180),this.game.device.desktop&&(this.game.input.keyboard.addKey(Phaser.Keyboard.ENTER).onDown.add(function(){this.dialogMessagesActive?($("#mymessage").val().trim()&&this.game.socket.emit(EventCode.CHAT_MESSAGE,{id:this.game.socket.id,m:$("#mymessage").val().trim()},!0),$("#mymessage").val(""),$("#messages").css({top:$(document).height()/2,left:$(document).width()/2})):(this.dialogMessagesActive=!0,$("#messages").css({top:$(document).height()/2,left:$(document).width()/2}),$("#messages").show(),$("#labelm").trigger("click"),$("#messages").focus())}.bind(this),this),$("#buttonCloseMessagesInput").click(function(){this.dialogMessagesActive&&(this.dialogMessagesActive=!1,$("#messages").hide())}.bind(this))),this.game.device.desktop?this.game.input.onDown.add(function(){this.localPlayer.fired=1}.bind(this),this):this.game.input.onHold.add(function(){this.localPlayer.fired=1}.bind(this),this),this.game.input.onUp.add(function(){this.localPlayer.fired=0}.bind(this),this),this.explosions=this.game.add.group(),this.explosions.name="explosion",this.explosions.createMultiple(30,"explosion"),this.explosions.forEach(this.setupExplosion,this),this.layerCoins=this.game.add.group(),this.layerCoins.enableBody=!0,this.bulletsIcon=this.game.add.image(200,18,"bullets"),this.bulletsIcon.fixedToCamera=!0,this.game.numBullets=this.game.add.bitmapText(245,15,"p2","x10",20),this.game.numBullets.fixedToCamera=!0,this.game.numBullets.angle=180,this.game.leaderboard=this.game.add.bitmapText(this.game.width-150,15,"p2","",15),this.game.leaderboard.fixedToCamera=!0,this.game.leaderboard.angle=180,this.killsIcon=this.game.add.image(300,15,"skull"),this.killsIcon.fixedToCamera=!0,this.game.numKills=this.game.add.bitmapText(335,15,"p2","x0",20),this.game.numKills.fixedToCamera=!0,this.game.numKills.angle=180,
this.game.started=!0,$("#leaderboard").show(),this.MOVE_LIMIT=-100,this.MOVE_SPEED=7e3,this.game.device.desktop&&(this.game.messagesToAll=this.game.add.bitmapText(0,$(document).height()-47,"p2","Press Enter to send a message",22),this.game.messagesToAll.fixedToCamera=!0,this.game.messagesToAll.angle=180,this.wobble=this.MOVE_LIMIT,this.game.add.tween(this).to({wobble:screen.width*window.devicePixelRatio},this.MOVE_SPEED,null,!0,0,-1,!1)),this.game.camera.follow(this.localPlayer),this.game.camera.roundPx=!1;var e=this.game.add.graphics(0,0);this.miniMap=new MiniMap(this.game,$(document).width()-105,$(document).height()-105,e)},PlayState.prototype.setupExplosion=function(a){a.anchor.x=.5,a.anchor.y=.5,a.animations.add("explosion")},PlayState.prototype.createCoins=function(){this.layerCoins.destroy(),this.layerCoins=this.game.add.group(),this.layerCoins.enableBody=!0;for(var a=0;a<this.game.coins.length;a++){var b=this.game.coins[a][0],c=this.game.coins[a][1];if(this.game.device.desktop)setTimeout(function(a,b){var c=this.layerCoins.create(a,b,"coins",0);c.anchor.setTo(.5),c.moves=!1,c.animations.add("rot"),c.play("rot",15,!0);var d=this.game.add.tween(c);c.width=0,c.height=0,d.to({width:24,height:24},2e3,Phaser.Easing.Elastic.In),d.start()}.bind(this,b,c),100*a);else{var d=this.layerCoins.create(b,c,"coins",0);d.anchor.setTo(.5),d.moves=!1,d.width=24,d.height=24}}this.game.coins=[]},PlayState.prototype.update=function(){this.game.device.desktop&&(this.game.messagesToAll.cameraOffset.x=this.wobble,this.game.messagesToAll.cameraOffset.y=$(document).height()*window.devicePixelRatio-30),this.game.coins.length>0&&this.createCoins(),this.game.waitingLabel&&!this.game.waiting&&this.game.waitingLabel.destroy();for(var a=0;a<this.game.players.length;a++){var b=this.game.players[a];this.game.physics.arcade.overlap(this.game.layerEnemies,b.getBullets(),this.bulletToSprite,null,this);for(var c=0;c<this.game.players.length;c++){var d=this.game.players[c];b!==d&&this.game.physics.arcade.overlap(b,d.getBullets(),this.bulletToSprite,null,this)}}this.game.physics.arcade.overlap(this.game.layerPlayers,this.layerCoins,this.coinsCollision,null,this),this.miniMap.update()},PlayState.prototype.coinsCollision=function(a,b){if(this.game.device.desktop){var c=this.game.add.tween(b);c.to({width:0,height:0,x:a.x,y:a.y,alpha:0,tint:0},50),c.onComplete.add(function(){b.destroy()},this),c.start()}else b.destroy()},PlayState.prototype.bulletToSprite=function(a,b){a.id!==b.id,b.explode=!1,b.kill();var c=this.explosions.getFirstExists(!1);c.reset(a.x,a.y),c.play("explosion",10,!1,!0)},PlayState.prototype.initGame=function(a){this.game.layerPlayers=this.game.add.group(),this.game.layerPlayers.enableBody=!0;for(var b=0;b<a.players.length;b++){var c=new Player(this.game,a.players[b]);this.game.players.push(c),this.game.socket.id===a.players[b].id&&(this.localPlayer=c),this.game.layerPlayers.add(c)}for(var b=0;b<a.coins.length;b++){var d=a.coins[b][0],e=a.coins[b][1];this.game.coins[b]=[d,e]}this.game.layerEnemies=this.game.add.group(),this.game.layerEnemies.enableBody=!0;for(var b=0;b<a.enemies.length;b++){var f=a.enemies[b].id,g=new Enemy(this.game,0,0,"enemy",0,f);this.game.layerEnemies.add(g),this.game.enemies.push(g)}1===this.game.players.length&&(this.game.waiting=!0)};var MiniMap=function(a,b,c,d){this.game=a,this.x=b,this.y=c,this.scale=.03,this.width=this.game.world.bounds.width*this.scale,this.height=this.game.world.bounds.height*this.scale,this.playerDiameter=.07*this.width,this.enemyDiameter=.04*this.width,this.MapBackground=d,this.init()};MiniMap.prototype.init=function(){this.MapBackground.fixedToCamera=!0,this.x=$(document).width()*window.devicePixelRatio-this.width-5,this.y=$(document).height()*window.devicePixelRatio-this.height-5},MiniMap.prototype.update=function(){this.drawMapBackground(),this.drawPlayers(),this.drawEnemies()},MiniMap.prototype.drawMapBackground=function(){this.MapBackground.clear(),this.MapBackground.beginFill(0,.6),this.MapBackground.drawRect(this.x,this.y,this.width,this.height),this.MapBackground.endFill()},MiniMap.prototype.drawPlayer=function(a,b,c){var d=this.scaleCoor(a,b),e=c?16777215:6723993;this.MapBackground.beginFill(e,1),this.MapBackground.drawCircle(d[0],d[1],this.playerDiameter),this.MapBackground.endFill()},MiniMap.prototype.drawPlayers=function(){this.game.players.forEach(function(a,b){var c=a.id===this.game.socket.id;this.drawPlayer(a.x,a.y,c)}.bind(this))},MiniMap.prototype.drawEnemy=function(a,b){var c=this.scaleCoor(a,b),d=16711680;this.MapBackground.beginFill(d,1),this.MapBackground.drawCircle(c[0],c[1],this.enemyDiameter),this.MapBackground.endFill()},MiniMap.prototype.drawEnemies=function(){this.game.enemies.forEach(function(a,b){this.drawEnemy(a.x,a.y)}.bind(this))},MiniMap.prototype.scaleCoor=function(a,b){var a=a/this.game.world.bounds.width*this.width+this.x,b=b/this.game.world.bounds.height*this.height+this.y;return[a,b]};var EventCode={PING:0,JOIN_GAME:1,UPDATE_GAME:2,CHAT_MESSAGE:3,UPDATE_GAMES_LIST:4,NEW_PLAYER:5,INI_STATUS:6,PLAYER_LEFT:7,GAME_OVER:8,UPDATE_PLAYER:9,LEADERBOARD:10,COINS:11},Entity={Player:{TYPE:0,TypeOfMessage:{Update:{CODE:0,LEN:21},Kill:{CODE:1,LEN:1}},LEN:21},Enemy:{TYPE:4,TypeOfMessage:{Update:{CODE:0,LEN:13},Kill:{CODE:1,LEN:1},Create:{CODE:2,LEN:1}}}};